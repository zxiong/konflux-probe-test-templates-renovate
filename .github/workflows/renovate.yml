name: Renovate

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # Install the tool on the runner VM
      - name: Install pipeline-migration-tool
        run: |
          pipx install git+https://github.com/konflux-ci/pipeline-migration-tool.git
          # Verify it runs
          pipeline-migration-tool --version || echo "Tool installed"

      # Run Renovate using NPM
      - name: Renovate
        # Force latest version to minimize compatibility issues
        run: npx renovate@latest
        env:
          RENOVATE_CONFIG_FILE: renovate.json
          RENOVATE_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          RENOVATE_PLATFORM: github
          RENOVATE_ENDPOINT: https://api.github.com
          
          RENOVATE_USERNAME: renovate-bot
          RENOVATE_GIT_AUTHOR: 'Renovate Bot <bot@renovateapp.com>'
          
          # Allow the tool (matches the command 'pipeline-migration-tool')
          RENOVATE_ALLOWED_POST_UPGRADE_COMMANDS: '["^pipeline-migration-tool.*"]'
          
          LOG_LEVEL: debug
